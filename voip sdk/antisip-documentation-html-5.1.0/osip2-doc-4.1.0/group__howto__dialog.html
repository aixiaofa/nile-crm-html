<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>libosip: How-To manage dialogs.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">libosip
   &#160;<span id="projectnumber">4.1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">How-To manage dialogs.</div>  </div>
</div><!--header-->
<div class="contents">
<h1><a class="anchor" id="howto_dialog1"></a>
Description.</h1>
<p>Full API is there:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="osip__dialog_8h.html" title="oSIP dialog Routines">osip2/osip_dialog.h</a>&gt;</span></div>
</div><!-- fragment --><p>Dialog management is a powerful facility given by oSIP. This feature is needed by SIP end point who has the capability to answer calls. (i.e. answering 200 OK to an INVITE).</p>
<p>A Dialog is a context for a call establishment in oSIP. It's not useless to say that ONE invite request can lead to several call establishment. This can happen if your call has been forked by a proxy and several user agent was contacted and replied at the same time. It is true that this case won't probably happen several times a month...</p>
<p>There is two ways of creating a dialog. In one case, you are the CALLER and in the other case, you will be the CALLEE.</p>
<h1><a class="anchor" id="howto_dialog2"></a>
Creating a dialog as a CALLER.</h1>
<p>In this case, you have to create a dialog each time you receive an answer with a code between 101 and 299. The best place in oSIP to actually create a dialog is of course in the callback that announce such SIP messages. Of course, each time you receive a response, you have to check for an existing dialog associated to this INVITE that can have been created by earlier SIP answer coming from the same User Agent. The code in the callback will look like the following:</p>
<div class="fragment"><div class="line">  <span class="keywordtype">void</span> cb_rcv1xx(<a class="code" href="structosip__transaction.html">osip_transaction_t</a> *tr,<a class="code" href="structosip__message.html">osip_message_t</a> *sip)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="structosip__dialog.html">osip_dialog_t</a> *dialog;</div>
<div class="line">    <span class="keywordflow">if</span> (MSG_IS_RESPONSEFOR(sip, <span class="stringliteral">&quot;INVITE&quot;</span>)&amp;&amp;!<a class="code" href="group__oSIP__MESSAGE.html#ga6537e0c8a909c1119f22308b37bbccd3">MSG_TEST_CODE</a>(sip, 100))</div>
<div class="line">    {</div>
<div class="line">      dialog = my_application_search_existing_dialog(sip);</div>
<div class="line">      <span class="keywordflow">if</span> (dialog==NULL) <span class="comment">//NO EXISTING DIALOG</span></div>
<div class="line">      {</div>
<div class="line">        i = <a class="code" href="group__oSIP__DIALOG.html#ga17e289b805d354b000d22a9b8eac10d0">osip_dialog_init_as_uac</a>(&amp;dialog, sip);</div>
<div class="line">        my_application_add_existing_dialog(dialog);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">no dialog establishment <span class="keywordflow">for</span> other REQUEST</div>
<div class="line">    }</div>
<div class="line">  }</div>
</div><!-- fragment --><h1><a class="anchor" id="howto_dialog3"></a>
Creating a dialog as a CALLEE</h1>
<p>In this case, you will have to create a dialog upon receiving the first transmission of the INVITE request. The correct place to do that is inside the callback previously registered to announce new INVITE. First, you will build a SIP answer like 180 or 200 and you'll be able to create a dialog by calling the following code:</p>
<div class="fragment"><div class="line"><a class="code" href="structosip__dialog.html">osip_dialog_t</a> *dialog;</div>
<div class="line"><a class="code" href="group__oSIP__DIALOG.html#gaacc1832e88573544882a9a3b563657b8">osip_dialog_init_as_uas</a>(&amp;dialog, original_invite, response_that_you_build);</div>
</div><!-- fragment --><p>To make things working, you MUST create a VALID response: do not forget to create a new tag and put it in the 'To' header. The dialog management heavily depends on this tag.</p>
<h1><a class="anchor" id="howto_dialog4"></a>
Matching REQUEST against existing dialog.</h1>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (<a class="code" href="group__oSIP__DIALOG.html#ga654f37ea9b0c7525d1695b51cfd067e4">osip_dialog_match_as_uas</a> (jd-&gt;d_dialog, evt-&gt;<a class="code" href="structosip__event.html#aec751d01012221e204a06d957991665c">sip</a>) == 0)</div>
<div class="line">  <span class="keywordflow">break</span>;</div>
</div><!-- fragment --><h1><a class="anchor" id="howto_dialog5"></a>
Matching cancel against an INVITE.</h1>
<p>Here is code that I use in eXosip2 to match incoming CANCEL against previous received INVITE. This is a bit different than dialog because CANCEL match a specific INVITE transaction, not a dialog:</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">_cancel_match_invite (<a class="code" href="structosip__transaction.html">osip_transaction_t</a> * invite, <a class="code" href="structosip__message.html">osip_message_t</a> * cancel)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="structosip__uri__param.html">osip_generic_param_t</a> *br;</div>
<div class="line">  <a class="code" href="structosip__uri__param.html">osip_generic_param_t</a> *br2;</div>
<div class="line">  <a class="code" href="structosip__via.html">osip_via_t</a> *via;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="group__oSIP__VIA.html#ga4d14b3411ff9a3e5697060de4be42274">osip_via_param_get_byname</a> (invite-&gt;<a class="code" href="structosip__transaction.html#a7b8ca6b3bbf08eff1a6630e513134f7d">topvia</a>, <span class="stringliteral">&quot;branch&quot;</span>, &amp;br);</div>
<div class="line">  via = <a class="code" href="group__oSIP__LIST.html#gafae79d4662f05819a27d895b7b910b3d">osip_list_get</a> (&amp;cancel-&gt;<a class="code" href="structosip__message.html#a32c018d3af5c3d327e188a2031a31d61">vias</a>, 0);</div>
<div class="line">  <span class="keywordflow">if</span> (via == NULL)</div>
<div class="line">    <span class="keywordflow">return</span> OSIP_SYNTAXERROR;    <span class="comment">// request without via?</span></div>
<div class="line">  <a class="code" href="group__oSIP__VIA.html#ga4d14b3411ff9a3e5697060de4be42274">osip_via_param_get_byname</a> (via, <span class="stringliteral">&quot;branch&quot;</span>, &amp;br2);</div>
<div class="line">  <span class="keywordflow">if</span> (br != NULL &amp;&amp; br2 == NULL)</div>
<div class="line">    <span class="keywordflow">return</span> OSIP_UNDEFINED_ERROR;</div>
<div class="line">  <span class="keywordflow">if</span> (br2 != NULL &amp;&amp; br == NULL)</div>
<div class="line">    <span class="keywordflow">return</span> OSIP_UNDEFINED_ERROR;</div>
<div class="line">  <span class="keywordflow">if</span> (br2 != NULL &amp;&amp; br != NULL) {      <span class="comment">// compliant UA :)</span></div>
<div class="line">    <span class="keywordflow">if</span> (br-&gt;<a class="code" href="structosip__uri__param.html#a12155be83e503b9db43e8ea0dc519602">gvalue</a> != NULL &amp;&amp; br2-&gt;<a class="code" href="structosip__uri__param.html#a12155be83e503b9db43e8ea0dc519602">gvalue</a> != NULL &amp;&amp; 0 == strcmp (br-&gt;<a class="code" href="structosip__uri__param.html#a12155be83e503b9db43e8ea0dc519602">gvalue</a>, br2-&gt;<a class="code" href="structosip__uri__param.html#a12155be83e503b9db43e8ea0dc519602">gvalue</a>))</div>
<div class="line">      <span class="keywordflow">return</span> OSIP_SUCCESS;</div>
<div class="line">    <span class="keywordflow">return</span> OSIP_UNDEFINED_ERROR;</div>
<div class="line">  }</div>
<div class="line">  /old backward compatibility mechanism</div>
<div class="line">  <span class="keywordflow">if</span> (0 != <a class="code" href="group__oSIP__CALL__ID.html#ga742dfbf96130acfb1ed45a440ca1edec">osip_call_id_match</a> (invite-&gt;<a class="code" href="structosip__transaction.html#a8b57704a4f1f1214447f48314e5e8e4c">callid</a>, cancel-&gt;<a class="code" href="structosip__message.html#a805416c170f4fc4932bf9c4b1165558f">call_id</a>))</div>
<div class="line">    <span class="keywordflow">return</span> OSIP_UNDEFINED_ERROR;</div>
<div class="line">  <span class="keywordflow">if</span> (0 != <a class="code" href="group__oSIP__TO.html#gaf7ee74c44adc871b30aa310e0f272e39">osip_to_tag_match</a> (invite-&gt;<a class="code" href="structosip__transaction.html#ad602469ef8eb9389139061fe8f85f495">to</a>, cancel-&gt;<a class="code" href="structosip__message.html#a252037e660487124d8bde7a866d21a93">to</a>))</div>
<div class="line">    <span class="keywordflow">return</span> OSIP_UNDEFINED_ERROR;</div>
<div class="line">  <span class="keywordflow">if</span> (0 != <a class="code" href="group__oSIP__FROM.html#ga5fcd64817ac9eb3902b4d53785e63702">osip_from_tag_match</a> (invite-&gt;<a class="code" href="structosip__transaction.html#af44406de83c556c6ecab47ff6b1bc114">from</a>, cancel-&gt;<a class="code" href="structosip__message.html#a8b768e221488592a85d3abb42d166010">from</a>))</div>
<div class="line">    <span class="keywordflow">return</span> OSIP_UNDEFINED_ERROR;</div>
<div class="line">  <span class="keywordflow">if</span> (0 != <a class="code" href="group__oSIP__VIA.html#ga0b64a222ff266a59865dc97ad52cf85e">osip_via_match</a> (invite-&gt;<a class="code" href="structosip__transaction.html#a7b8ca6b3bbf08eff1a6630e513134f7d">topvia</a>, via))</div>
<div class="line">    <span class="keywordflow">return</span> OSIP_UNDEFINED_ERROR;</div>
<div class="line">  <span class="keywordflow">return</span> OSIP_SUCCESS;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Nov 19 2014 22:06:20 for libosip by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.2
</small></address>
</body>
</html>
