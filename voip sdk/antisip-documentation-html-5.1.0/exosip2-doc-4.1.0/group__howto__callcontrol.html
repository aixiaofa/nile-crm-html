<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>libeXosip2: How-To initiate, modify or terminate calls.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">libeXosip2
   &#160;<span id="projectnumber">4.1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">How-To initiate, modify or terminate calls.</div>  </div>
<div class="ingroups"><a class="el" href="group__libeXosip2.html">The eXtented eXosip stack</a></div></div><!--header-->
<div class="contents">
<p>eXosip2 offers a flexible API to help you controling calls.</p>
<h2>Initiate a call</h2>
<p>To start an outgoing call, you typically need a few headers which will be used by eXosip2 to build a default SIP INVITE request. The code below is used to start a call:</p>
<div class="fragment"><div class="line">osip_message_t *invite;</div>
<div class="line"><span class="keywordtype">int</span> cid;</div>
<div class="line"><span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">i = <a class="code" href="group__eXosip2__call.html#ga8bc38c019a006f933e41c270e28e32f1">eXosip_call_build_initial_invite</a> (ctx, &amp;invite, <span class="stringliteral">&quot;&lt;sip:to@antisip.com&gt;&quot;</span>,</div>
<div class="line">                                      <span class="stringliteral">&quot;&lt;sip:from@antisip.com&gt;&quot;</span>,</div>
<div class="line">                                      NULL, <span class="comment">// optional route header</span></div>
<div class="line">                                      <span class="stringliteral">&quot;This is a call for a conversation&quot;</span>);</div>
<div class="line"><span class="keywordflow">if</span> (i != 0)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">osip_message_set_supported (invite, <span class="stringliteral">&quot;100rel&quot;</span>);</div>
<div class="line"></div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">char</span> tmp[4096];</div>
<div class="line">  <span class="keywordtype">char</span> localip[128];</div>
<div class="line"></div>
<div class="line">  <a class="code" href="group__eXosip2__network.html#ga86599a1fff7c237bab6b1297c6a1faab">eXosip_guess_localip</a> (ctx, AF_INET, localip, 128);</div>
<div class="line">  snprintf (tmp, 4096,</div>
<div class="line">            <span class="stringliteral">&quot;v=0\r\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;o=jack 0 0 IN IP4 %s\r\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;s=conversation\r\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;c=IN IP4 %s\r\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;t=0 0\r\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;m=audio %s RTP/AVP 0 8 101\r\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;a=rtpmap:0 PCMU/8000\r\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;a=rtpmap:8 PCMA/8000\r\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;a=rtpmap:101 telephone-event/8000\r\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;a=fmtp:101 0-11\r\n&quot;</span>, localip, localip, port);</div>
<div class="line">  osip_message_set_body (invite, tmp, strlen (tmp));</div>
<div class="line">  osip_message_set_content_type (invite, <span class="stringliteral">&quot;application/sdp&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__eXosip2__conf.html#ga8cfc31ccea950849ba01dfa470327ef2">eXosip_lock</a> (ctx);</div>
<div class="line">cid = <a class="code" href="group__eXosip2__call.html#ga6763747cca25032940afc0039e24835d">eXosip_call_send_initial_invite</a> (ctx, invite);</div>
<div class="line"><span class="keywordflow">if</span> (cid &gt; 0)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="group__eXosip2__call.html#ga62ad594f62b796def3741a7969b38287">eXosip_call_set_reference</a> (ctx, i, reference);</div>
<div class="line">  }</div>
<div class="line"><a class="code" href="group__eXosip2__conf.html#ga37922fb78da0868b52f29d22a4b827ae">eXosip_unlock</a> (ctx);</div>
<div class="line"><span class="keywordflow">return</span> i;</div>
</div><!-- fragment --><p>The above code is using eXosip_call_build_initial_invite to build a default SIP INVITE request for a new call. You have to insert a SDP body announcing your audio parameter for the RTP stream.</p>
<p>The above code also show the flexibility of the eXosip2 API which allow you to insert additionnal headers such as "Supported: 100rel" (announcing support for a SIP extension). Thus you can enterely control the creation of SIP requests.</p>
<p>The returned element of eXosip_call_send_initial_invite is the cid (call identifier) that you can use to send a CANCEL. In future events other than 100 Trying, you'll also get the did (dialog identifier) that will also be needed to control established calls.</p>
<p>eXosip_call_set_reference is also a mean to attach one of your own context to a call so that you'll get your pointer back in <a class="el" href="structeXosip__event.html">eXosip_event</a>.</p>
<h2>Answer a call</h2>
<p>The code below is another example that teach you how to answer an incoming call.</p>
<p>You'll usually need to send a "180 Ringing" SIP answer when receiving a SIP INVITE:</p>
<div class="fragment"><div class="line"><a class="code" href="group__eXosip2__conf.html#ga8cfc31ccea950849ba01dfa470327ef2">eXosip_lock</a> (ctx);</div>
<div class="line"><a class="code" href="group__eXosip2__call.html#ga55f8a8886aeafc2d8be32e9652f5abab">eXosip_call_send_answer</a> (ctx, evt-&gt;<a class="code" href="structeXosip__event.html#a49280ad5e6963a9aeb50d20bc08974cf">tid</a>, 180, NULL);</div>
<div class="line"><a class="code" href="group__eXosip2__conf.html#ga37922fb78da0868b52f29d22a4b827ae">eXosip_unlock</a> (ctx);</div>
</div><!-- fragment --><p><b>Note</b>: The above code also shows that the stack is sometimes able to build and send a default SIP messages with only one API call</p>
<p>Then, when the user wants to answer the call, you'll need to send a 200 ok and insert a SDP body in your SIP answer:</p>
<div class="fragment"><div class="line">osip_message_t *answer = NULL;</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__eXosip2__conf.html#ga8cfc31ccea950849ba01dfa470327ef2">eXosip_lock</a> (ctx);</div>
<div class="line">i = <a class="code" href="group__eXosip2__call.html#gad8ca3d72694c3f881115bbfba0dc4ef2">eXosip_call_build_answer</a> (ctx, evt-&gt;<a class="code" href="structeXosip__event.html#a49280ad5e6963a9aeb50d20bc08974cf">tid</a>, 200, &amp;answer);</div>
<div class="line"><span class="keywordflow">if</span> (i != 0)</div>
<div class="line">{</div>
<div class="line">   <a class="code" href="group__eXosip2__call.html#ga55f8a8886aeafc2d8be32e9652f5abab">eXosip_call_send_answer</a> (ctx, evt-&gt;<a class="code" href="structeXosip__event.html#a49280ad5e6963a9aeb50d20bc08974cf">tid</a>, 400, NULL);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">{</div>
<div class="line">   i = sdp_complete_200ok (evt-&gt;<a class="code" href="structeXosip__event.html#a54517d01d0899636d0df8e7dde1886d5">did</a>, answer);</div>
<div class="line">   <span class="keywordflow">if</span> (i != 0)</div>
<div class="line">   {</div>
<div class="line">      osip_message_free (answer);</div>
<div class="line">      <a class="code" href="group__eXosip2__call.html#ga55f8a8886aeafc2d8be32e9652f5abab">eXosip_call_send_answer</a> (ctx, evt-&gt;<a class="code" href="structeXosip__event.html#a49280ad5e6963a9aeb50d20bc08974cf">tid</a>, 415, NULL);</div>
<div class="line">   }</div>
<div class="line">   <span class="keywordflow">else</span></div>
<div class="line">      <a class="code" href="group__eXosip2__call.html#ga55f8a8886aeafc2d8be32e9652f5abab">eXosip_call_send_answer</a> (ctx, evt-&gt;<a class="code" href="structeXosip__event.html#a49280ad5e6963a9aeb50d20bc08974cf">tid</a>, 200, answer);</div>
<div class="line">}</div>
<div class="line"><a class="code" href="group__eXosip2__conf.html#ga37922fb78da0868b52f29d22a4b827ae">eXosip_unlock</a> (ctx);</div>
</div><!-- fragment --><p><b>Note</b>: In the above code, you can note that to send a response to a request, you have to use the tid (transaction identifier) and not a cid (call identifier) or a did (dialog identifier).</p>
<p><b>Note2</b>: For sending a 200ok, you'll usually need to insert a SDP body in the answer and before this, to negotiate the parameters and codecs that you want to support. This is left to you! Once you have created the SDP, you add it in the answer using the following code:</p>
<div class="fragment"><div class="line">osip_message_set_body (answer, tmp, strlen (tmp));</div>
<div class="line">osip_message_set_content_type (answer, <span class="stringliteral">&quot;application/sdp&quot;</span>);</div>
</div><!-- fragment --><h2>Terminate a Call</h2>
<p>Simple API, no much to say about it! You can use it when you want: it will either send a CANCEL, a negative answer or a BYE depending on the call state.</p>
<div class="fragment"><div class="line"><a class="code" href="group__eXosip2__conf.html#ga8cfc31ccea950849ba01dfa470327ef2">eXosip_lock</a> (ctx);</div>
<div class="line"><a class="code" href="group__eXosip2__call.html#ga4ab75aeeeb963e07e20f8939414fc997">eXosip_call_terminate</a> (ctx, cid, did);</div>
<div class="line"><a class="code" href="group__eXosip2__conf.html#ga37922fb78da0868b52f29d22a4b827ae">eXosip_unlock</a> (ctx);</div>
</div><!-- fragment --><p><b>Note</b>: You can't stop a call where no 100 Trying has been received. In that case, you need to wait before sending a CANCEL or a BYE... This is per rfc3261.</p>
<h2>Sending INFO, REFER, UPDATE, NOTIFY, OPTIONS request</h2>
<p>The call control API allows you to send and receive REFER, UPDATE, INFO, OPTIONS, NOTIFY and INVITEs whitin calls.</p>
<p>Here you have a code sample to send an INFO requests used to send an out of band dtmf within the signalling layer. (not standard, but still used on some system!)</p>
<div class="fragment"><div class="line">osip_message_t *info;</div>
<div class="line"><span class="keywordtype">char</span> dtmf_body[1000];</div>
<div class="line"><span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__eXosip2__conf.html#ga8cfc31ccea950849ba01dfa470327ef2">eXosip_lock</a> (ctx);</div>
<div class="line">i = <a class="code" href="group__eXosip2__call.html#gae04acaf1df17edb813af33158b1c0c32">eXosip_call_build_info</a> (ctx, evt-&gt;<a class="code" href="structeXosip__event.html#a54517d01d0899636d0df8e7dde1886d5">did</a>, &amp;info);</div>
<div class="line"><span class="keywordflow">if</span> (i == 0)</div>
<div class="line">{</div>
<div class="line">   snprintf (dtmf_body, 999, <span class="stringliteral">&quot;Signal=%c\r\nDuration=250\r\n&quot;</span>, c);</div>
<div class="line">   osip_message_set_content_type (info, <span class="stringliteral">&quot;application/dtmf-relay&quot;</span>);</div>
<div class="line">   osip_message_set_body (info, dtmf_body, strlen (dtmf_body));</div>
<div class="line">   i = <a class="code" href="group__eXosip2__call.html#ga9f52aeb977973fa39ef021ebb164316e">eXosip_call_send_request</a> (ctx, evt-&gt;<a class="code" href="structeXosip__event.html#a54517d01d0899636d0df8e7dde1886d5">did</a>, info);</div>
<div class="line">}</div>
<div class="line"><a class="code" href="group__eXosip2__conf.html#ga37922fb78da0868b52f29d22a4b827ae">eXosip_unlock</a> (ctx);</div>
</div><!-- fragment --><h2>Sending any other request, with any header</h2>
<p>You can in fact, send any kind of other request using eXosip2 API.</p>
<p>You will find many other API to build any kind of sip message. Using osip API, you can add any header or body in those message. eXosip2 will always prepare the minimal and technical stuff you need.</p>
<div class="fragment"><div class="line">osip_message_t *message;</div>
<div class="line"><span class="keywordtype">char</span> body[1000];</div>
<div class="line"><span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__eXosip2__conf.html#ga8cfc31ccea950849ba01dfa470327ef2">eXosip_lock</a> (ctx);</div>
<div class="line">i = <a class="code" href="group__eXosip2__call.html#ga14be893f5066b6312bd4673fc1ee1c82">eXosip_call_build_request</a> (ctx, evt-&gt;<a class="code" href="structeXosip__event.html#a54517d01d0899636d0df8e7dde1886d5">did</a>, <span class="stringliteral">&quot;PRIVATECOMMAND&quot;</span>, &amp;message);</div>
<div class="line"><span class="keywordflow">if</span> (i == 0)</div>
<div class="line">{</div>
<div class="line">   snprintf (body, 999, <span class="stringliteral">&quot;room=1;light=on\r\nroom=2;light=off\r\n&quot;</span>);</div>
<div class="line">   osip_message_set_content_type (message, <span class="stringliteral">&quot;application/antisip-domotic&quot;</span>);</div>
<div class="line">   osip_message_set_body (message, body, strlen (body));</div>
<div class="line"></div>
<div class="line">   osip_message_set_header (invite, <span class="stringliteral">&quot;P-MyCommand&quot;</span>, <span class="stringliteral">&quot;option=value&quot;</span>);</div>
<div class="line"></div>
<div class="line">   i = <a class="code" href="group__eXosip2__call.html#ga9f52aeb977973fa39ef021ebb164316e">eXosip_call_send_request</a> (ctx, evt-&gt;<a class="code" href="structeXosip__event.html#a54517d01d0899636d0df8e7dde1886d5">did</a>, message);</div>
<div class="line">}</div>
<div class="line"><a class="code" href="group__eXosip2__conf.html#ga37922fb78da0868b52f29d22a4b827ae">eXosip_unlock</a> (ctx);</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Nov 19 2014 22:14:42 for libeXosip2 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.2
</small></address>
</body>
</html>
